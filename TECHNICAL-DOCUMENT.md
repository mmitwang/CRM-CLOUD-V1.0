# CRM系统技术文档

## 1. 系统架构

### 1.1 整体架构
- **前端**: Vue 3 + Element Plus + Pinia + Axios
- **后端**: FastAPI + SQLAlchemy + MySQL
- **容器化**: Docker + Docker Compose
- **部署方式**: 远程服务器部署

### 1.2 核心组件

| 组件 | 技术栈 | 功能描述 |
|------|--------|----------|
| 前端框架 | Vue 3 | 提供现代化的前端开发体验 |
| UI组件库 | Element Plus | 提供美观的界面组件 |
| 状态管理 | Pinia | 管理应用状态 |
| HTTP客户端 | Axios | 处理API请求 |
| 后端框架 | FastAPI | 高性能的Python后端框架 |
| ORM | SQLAlchemy | 数据库对象关系映射 |
| 数据库 | MySQL | 存储系统数据 |
| 认证 | JWT | 无状态的用户认证 |

## 2. 核心功能

### 2.1 用户认证
- 基于JWT的用户认证系统
- 支持多租户架构，用户与公司关联
- 测试账户自动管理功能

### 2.2 客户管理
- 客户信息的增删改查
- 客户状态管理
- 客户关联设备管理

### 2.3 设备管理
- 设备信息的增删改查
- 设备状态监控
- 设备与客户关联

### 2.4 个人资料
- 用户个人信息管理
- 密码修改功能

## 3. 技术修复记录

### 3.1 登录功能修复

**问题描述**: 系统部署后无法登录，前端显示登录失败，后端返回401错误。

**根本原因**: bcrypt密码哈希算法对密码长度有限制（最大72字节），导致密码哈希生成失败。

**修复方案**: 
1. 修改`security.py`文件，实现简化的密码哈希方法
2. 确保密码验证逻辑能够处理简化的哈希格式
3. 优化数据库初始化脚本，确保测试用户正确创建

**修复文件**: 
- `backend/app/utils/security.py`
- `backend/init_db.py`

### 3.2 自动化测试实现

**问题描述**: 缺乏自动化测试工具，无法验证系统功能的有效性。

**解决方案**: 
1. 使用Playwright创建自动化浏览器测试脚本
2. 实现测试账户自动选择和登录功能
3. 验证核心页面的加载和功能
4. 提供详细的测试结果报告

**实现文件**: 
- `test-automated-browser.js`

## 4. 部署配置

### 4.1 环境变量

**前端配置**: 
- API_BASE_URL: 后端API基础URL

**后端配置**: 
- DATABASE_URL: 数据库连接字符串
- SECRET_KEY: JWT签名密钥
- ACCESS_TOKEN_EXPIRE_MINUTES: 访问令牌过期时间

### 4.2 Docker配置

**服务组件**: 
- frontend: 前端应用
- backend: 后端API
- mysql: 数据库

**网络配置**: 
- 前端端口: 8088
- 后端端口: 8087
- 数据库端口: 3307

## 5. 测试结果

### 5.1 自动化测试结果

| 测试项 | 状态 | 结果 |
|-------|------|------|
| 登录页面访问 | ✅ 通过 | 成功访问登录页面 |
| 登录功能 | ✅ 通过 | 成功使用测试账户登录系统 |
| 仪表盘页面 | ✅ 通过 | 成功加载仪表盘页面 |
| 客户管理页面 | ✅ 通过 | 成功加载客户管理页面 |
| 设备管理页面 | ✅ 通过 | 成功加载设备管理页面 |
| 个人资料页面 | ✅ 通过 | 成功加载个人资料页面 |
| 登出功能 | ✅ 通过 | 成功登出系统并跳转到登录页面 |

### 5.2 系统健康状态

| 组件 | 状态 | 说明 |
|------|------|------|
| 前端服务 | ✅ 正常 | 可访问并响应 |
| 后端服务 | ✅ 正常 | API响应正常 |
| 数据库服务 | ✅ 正常 | 连接正常，数据完整 |
| 认证系统 | ✅ 正常 | 登录功能正常 |

## 6. 版本信息

### 6.1 当前版本
- **版本号**: v1.0.1
- **发布日期**: 2026-02-04
- **状态**: 稳定

### 6.2 版本变更

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0.0 | 2026-02-02 | 初始版本发布 |
| v1.0.1 | 2026-02-04 | 修复登录功能，添加自动化测试 |

### 6.3 测试账户

| 账户类型 | 用户名 | 密码 | 公司 |
|---------|--------|------|------|
| 管理员 | admin@default.com@DEFAULT | 123456 | 默认公司 |
| 普通用户 | user@default.com@DEFAULT | 123456 | 默认公司 |
| 测试用户 | test@default.com@DEFAULT | 123456 | 默认公司 |
| 管理员 | admin@test1.com@TEST1 | 123456 | 测试公司1 |
| 普通用户 | user@test1.com@TEST1 | 123456 | 测试公司1 |
| 管理员 | admin@test2.com@TEST2 | 123456 | 测试公司2 |
| 普通用户 | user@test2.com@TEST2 | 123456 | 测试公司2 |

## 7. 技术支持

### 7.1 联系方式
- **技术支持**: tech@example.com
- **系统管理员**: admin@example.com

### 7.2 故障排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 登录失败 | 用户名或密码错误 | 检查测试账户信息 |
| 页面加载失败 | 网络连接问题 | 检查服务器状态 |
| API响应错误 | 后端服务异常 | 检查Docker容器状态 |
| 数据库连接失败 | MySQL服务异常 | 检查数据库容器状态 |

## 8. 未来规划

### 8.1 功能增强
- 添加设备实时监控功能
- 实现数据报表和分析
- 支持多语言国际化
- 优化移动端体验

### 8.2 性能优化
- 前端代码分割和懒加载
- 后端API缓存策略
- 数据库查询优化
- 服务端负载均衡
